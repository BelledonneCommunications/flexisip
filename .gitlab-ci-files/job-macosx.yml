.job-macosx:
  stage: build üèó
  tags: [ "macosx-min-xcode12.2" ]

  # Temporarily allows macosx jobs to fail because the machine that
  # was executing the macOS jobs is broken. Remove when it is
  # fixed.
  allow_failure: true

  script:
    - ccache -s
    - export OPENSSL_ROOT_DIR=/usr/local/opt/openssl
    - export MYSQL_DIR=/usr/local/opt/mysql-client
    - export CMAKE_BUILD_PARALLEL_LEVEL=$NJOBS
    - mkdir work
    - cmake -S . -B work -G "$CMAKE_GENERATOR" $DEFAULT_MACOS_CMAKE_OPTIONS $CMAKE_OPTIONS -DENABLE_SOCI_POSTGRESQL_BACKEND=OFF -DENABLE_UNIT_TESTS=ON -DENABLE_UNIT_TESTS_NGHTTP2ASIO=OFF -DENABLE_PROTOBUF=OFF
    - cmake --build work -- $ADDITIONAL_BUILD_OPTIONS
    - ccache -s


#################################################
# Makefile
#################################################

job-macosx-makefile:
  extends:
    - .job-macosx
    - .rules-dev  # ‚ö† See `rules.yml`
  variables:
    CMAKE_GENERATOR: Unix Makefiles
    NJOBS: $MAKEFILE_JOBS

#################################################
# Ninja
#################################################

job-macosx-ninja:
  extends:
    - .job-macosx
    - .rules-dev  # ‚ö† See `rules.yml`
  variables:
    CMAKE_GENERATOR: Ninja
    NJOBS: $NINJA_JOBS

#################################################
# Xcode
#################################################

job-macosx-xcode:
  extends:
    - .job-macosx
    - .rules-dev  # ‚ö† See `rules.yml`
  variables:
    CMAKE_GENERATOR: Xcode
    NJOBS: $MAX_NUMBER_TASK_XCODE
