FROM gitlab.linphone.org:4567/bc/public/linphone-sdk/bc-dev-debian:9
MAINTAINER  Jehan Monnier <jehan.monnier@linphone.org>

ARG njobs=1

USER root
WORKDIR /root


#get source code
COPY . flexisip/
RUN cd flexisip \
	&& ./prepare.py -c \
	&& ./prepare.py flexisip -d -DENABLE_CONFERENCE=ON -DENABLE_JWE_AUTH_PLUGIN=ON -DENABLE_EXTERNAL_AUTH_PLUGIN=ON \
		-DENABLE_PRESENCE=ON -DENABLE_PROTOBUF=ON -DENABLE_SNMP=ON -DENABLE_SOCI=ON -DENABLE_TRANSCODER=ON \
		-DCMAKE_PREFIX_PATH=/opt/belledonne-communications -DCMAKE_INSTALL_PREFIX=/opt/belledonne-communications -DSYSCONF_INSTALL_DIR=/etc \
	&& make -j ${njobs}


RUN mkdir -p /var/opt/belledonne-communications/flexisip /etc/flexisip


# Add it to the default path
ENV PATH=/opt/belledonne-communications/bin:$PATH


# Generate a default configuration
RUN flexisip --dump-default all > /etc/flexisip/flexisip.conf

RUN mkdir -p /home/cores


VOLUME /etc/flexisip
VOLUME /var/opt/belledonne-communications/log/flexisip
VOLUME /home/cores


#cleanup
RUN rm -rf flexisip


#ADD docker/flexisip-entrypoint.sh /root/entrypoint.sh
#RUN chmod +x /root/entrypoint.sh
#ENTRYPOINT /root/entrypoint.sh


ENTRYPOINT ["/opt/belledonne-communications/bin/flexisip"]
